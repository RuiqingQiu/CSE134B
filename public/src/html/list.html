<!DOCTYPE html>
<html>
<head>
    <title>Virtue / Vice</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="../css/list.css">
</head>
<body>
    <section>
        <h1 onclick="doSomething();">Habit List</h1>
        <ul id="habit-list">
            <script id="list-template" type="text/x-handlebars-template">
                {{#each this}}
                <li class="habit-entry" id="{{id}}">
                    <ul class="habit-info">
                        <li><div class="habit-name">{{title}}</div></li>
                        <li><img class="habit-icon" src="../../img/sleep.jpg" alt="habit icon"></li>
                    </ul>
                    <div class="message">
                        <span class="message-total">
                            <strong>{{current_value}}</strong> day(s) in a row! Best Record: <strong>{{max_value}}</strong><br>
                            <svg height="25" width="150">
                                <line x1="0" y1="0" x2="150" y2="0" style="stroke:rgba(171,171,171,0.6);stroke-width:25" />
                                <line x1="0" y1="0" x2="{{progress}}" y2="0" style="stroke:rgba(65, 131, 215, 0.8);stroke-width:25" />
                            </svg>
                        </span><br>
                        <span class="message-today">Completed <strong>1/1</strong> for today!</span>
                    </div>
                    <div class="habit-op">
                        <button type="button" class="op op-done" onclick="showMsg(this);" title="done">
                            <img src="../../img/done.svg" alt="Done">
                        </button>
                        <button type="button" class="op op-edit" onclick="location.href='edit.html'" title="edit habit">
                            <img src="../../img/edit.svg" alt="Edit">
                        </button>
                        <button type="button" class="op op-del"  title="delete habit">
                            <img src="../../img/delete.svg" alt="Del">
                        </button>
                    </div>
                </li>
                {{/each}}
            </script>
        </ul>
    </section>

    <button type="button" id="addHabit" onclick="location.href='add.html'" title="add habit">+</button>
    <script type="text/javascript" src="../../lib/jquery-2.1.4.min.js"></script>
    <script type="text/javascript" src="../../lib/parse-1.6.7.min.js"></script>
    <script type="text/javascript" src="../../lib/handlebars-v4.0.4.js"></script>
    <script type="text/javascript">
        const PROGRESS_BAR_LENGTH = 150;

        $( document ).ready(function() {
            Parse.initialize("ULppY5RxxZUo8yekihZdVH3uHLm24j5Q6298Un4O",
                           "mDAyhkdhlv6qH9lT9WFzMCeML6ycMa1S8oWlybVG");

            // console.log(Parse.User.current());
            if(Parse.User.current() == null || Parse.User.current().authenticated() == null) {
                window.location.href = "login.html";
            }
            listHabits();
        });

        function deleteHabit(id){
            // need to confirm first
            var habit = Parse.Object.extend("Habit");
            // var currUser = Parse.User.current();
            var query = new Parse.Query(habit);
            // query.equalTo("user_id", currUser);
            // query.equalTo("id", id);
            var toDelete = query.get(id, {
                success: function(obj) {
                    obj.destroy({
                        success: function(obj) {
                            alert("deleted!");
                        },
                        error: function(obj, error) {
                            alert("Error: " + error.code + " " + error.message);
                        }
                    });
                },
                error: function(obj, error) {
                    alert("Error: " + error.code + " " + error.message);
                }                
            });
        }

        function listHabits(){
            var habit = Parse.Object.extend("Habit");
            var query = new Parse.Query(habit);
            var currUser = Parse.User.current();
            query.equalTo("user_id", currUser);
            query.find({
                success: function(results) {
                    // var a = JSON.stringify(results);
                    // console.log(a);
                    var jsonArray =[];
                    for (var i = 0; i < results.length; i++){
                        var jsonData = {}
                        jsonData.id = results[i].id;
                        jsonData.title = results[i].get('title');
                        jsonData.icon_image = results[i].get('icon_image');
                        // jsonData.weekly_frequency = results[i].get('weekly_frequency');
                        jsonData.daily_frequency = results[i].get('daily_frequency');
                        jsonData.current_value = results[i].get('current_value');
                        jsonData.max_value = results[i].get('max_value');
                        jsonData.progress = jsonData.current_value / jsonData.max_value * PROGRESS_BAR_LENGTH;

                        jsonArray[i] = jsonData;
                    }
                    console.log(JSON.stringify(jsonArray));

                    renderHBTemplate($("#list-template"), jsonArray, $("#habit-list"));

                    $(".habit-entry .op-del").click(function(event){
                        event.preventDefault();
                        var toDelete = $(this).closest(".habit-entry").attr("id");
                        deleteHabit(toDelete);
                    });
                },
                error: function(error) {
                    alert("Error: " + error.code + " " + error.message);
                }
            });
        }

        function renderHBTemplate(tmpl, data, parent){
            var template = Handlebars.compile($(tmpl).html());
            $(parent).append(template(data));
        }

        function showMsg(element){
            var msgElement = (element.parentNode.parentNode.getElementsByClassName("message"))[0];
            msgElement.style.visibility="visible";
        }

        // function deleteHabit(element){
        //     var child = element.parentNode.parentNode;
        //     var parent = child.parentNode;
        //     parent.removeChild(child);
        // }

    </script>
</body>
</html>
